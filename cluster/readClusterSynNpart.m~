close all; clear all; clc;

%% Parameters of the scenario to be loaded
itCluster = 1;
T = 1000;
Nt = 10;
Nr = 20;
M = 2;
Ltrue = 1;
L = 1;
SNR = -3;
lHead = 0;
onOffModel = 0;
simId = 21;

maxNiter = 10000;
thrSER = 0.1;

%% Vary the number of particles
part_vec = [300 1000 3000 10000 30000];
ALL_LLH = zeros(length(part_vec),maxNiter);
ALL_SER_ALL_indiv = cell(1,length(part_vec));
ALL_SER_ALL_PGAS_indiv = cell(1,length(part_vec));
ALL_SER_ALL_FFBS_indiv = cell(1,length(part_vec));
for Nparticles = part_vec
    c = find(part_vec==Nparticles);
	saveFile = ['/export/clusterdata/franrruiz87/ModeloMIMO/results/synthetic/' num2str(simId)...
                            '/T' num2str(T) '_Nt' num2str(Nt) '_Nr' num2str(Nr) '_M' num2str(M) '_Ltrue' num2str(Ltrue) '_L' num2str(L) '_SNR' num2str(SNR) '_lHead' num2str(lHead), '_onOff' num2str(onOffModel) '_Npart' num2str(Nparticles) ...
                            '/itCluster' num2str(itCluster) '.mat'];
                        
    load(saveFile,'LLH','SER_ALL_indiv','SER_ALL_PGAS4_indiv','SER_ALL_FFBS4_indiv');
    
    ALL_LLH(c,:) = LLH(1:maxNiter);
    ALL_SER_ALL_indiv{c} = [ALL_SER_ALL_indiv{c}; SER_ALL_indiv(SER_ALL_indiv<thrSER)];
    ALL_SER_ALL_PGAS_indiv{c} = [ALL_SER_ALL_PGAS_indiv{c}; SER_ALL_PGAS4_indiv(SER_ALL_PGAS4_indiv<thrSER)];
    ALL_SER_ALL_FFBS_indiv{c} = [ALL_SER_ALL_FFBS_indiv{c}; SER_ALL_FFBS4_indiv(SER_ALL_FFBS4_indiv<thrSER)];
    
end

%% Plot LLH vs iterations
figure;
h = plot(1:maxNiter,ALL_LLH);
leyenda = cell(1,length(part_vec));
for i=1:length(part_vec)
    leyenda{i} = [num2str(part_vec(i)) ' particles'];
end
set(h(1),'LineStyle','-','Color',[0 0.6 0]);
set(h(2),'LineStyle','-.','Color','m');
set(h(3),'LineStyle','-','Color',[1 0.5 0]);
set(h(4),'LineStyle','--','Color','r');
set(h(5),'LineStyle',':','Color','k');
legend(leyenda,'Location','SouthEast');
grid on;
xlabel('Iterations');
ylabel('log-likelihood');
set(gca,'YLim',[-8 -5.5]*1e4);
figurapdf(4,3);  % Before: 3,2
print('-dpdf',['./plots/syn21/LLH_Npart_s.pdf']);

%% Plot SER vs Npart
avgSER = zeros(3,length(part_vec);





